services:
  postgres:
    image: postgres:13
    environment:
      POSTGRES_USER: airflow
      POSTGRES_PASSWORD: airflow
      POSTGRES_DB: airflow
    volumes:
      - postgres-data:/var/lib/postgresql/data

  # --- 1. Инициализация БД (выполняется один раз и завершается) ---
  airflow-init:
    image: my-airflow:3.1.3
    depends_on:
      - postgres
    user: "${AIRFLOW_UID:-50000}:${AIRFLOW_GID:-0}"
    environment:
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://airflow:airflow@postgres/airflow
      # Ключ, необходимый для миграции
      AIRFLOW__CORE__FERNET_KEY: "${AIRFLOW__CORE__FERNET_KEY}"
    command: [ "airflow", "db", "migrate" ]

  # --- 2. API server + UI (Web в Airflow 3) ---
  airflow-api-server:
    build: .
    image: my-airflow:3.1.3
    depends_on:
      - postgres
      - airflow-init
    user: "${AIRFLOW_UID:-50000}:${AIRFLOW_GID:-0}"
    environment:
      # Настройки БД и FERNET_KEY
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://airflow:airflow@postgres/airflow
      AIRFLOW__CORE__FERNET_KEY: "${AIRFLOW__CORE__FERNET_KEY}"

      # Общие настройки
      AIRFLOW__CORE__EXECUTOR: LocalExecutor
      AIRFLOW__CORE__DAGS_ARE_PAUSED_AT_CREATION: "true"
      AIRFLOW__CORE__LOAD_EXAMPLES: "false"
      AIRFLOW__LOGGING__LOGGING_LEVEL: "INFO"

      # Настройки Execution API (для входящих запросов)
      AIRFLOW__CORE__EXECUTION_API_SERVER_URL: "http://airflow-api-server:8080/execution/"
      AIRFLOW__WORKERS__EXECUTION_API_SERVER_URL: "http://airflow-api-server:8080/execution/"

      # Аутентификация UI
      AIRFLOW__CORE__AUTH_MANAGER: airflow.api_fastapi.auth.managers.simple.simple_auth_manager.SimpleAuthManager
      AIRFLOW__CORE__SIMPLE_AUTH_MANAGER_USERS: admin:admin

      # >>> общий JWT секрет для Execution API
      AIRFLOW__API_AUTH__JWT_SECRET: "${AIRFLOW__API_AUTH__JWT_SECRET}"

    volumes:
      - ./dags:/opt/airflow/dags
      - ./logs:/opt/airflow/logs
      - ./plugins:/opt/airflow/plugins
    ports:
      - "8080:8080"
    # Исправленная команда
    command: [ "bash", "-c", "sleep 5 && airflow api-server" ]

  # --- 3. dag-processor (Обязателен в Airflow 3) ---
  airflow-dag-processor:
    image: my-airflow:3.1.3
    depends_on:
      - postgres
      - airflow-init
      - airflow-api-server
    user: "${AIRFLOW_UID:-50000}:${AIRFLOW_GID:-0}"
    environment:
      # Настройки БД и FERNET_KEY
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://airflow:airflow@postgres/airflow
      AIRFLOW__CORE__FERNET_KEY: "${AIRFLOW__CORE__FERNET_KEY}"

      # Общие настройки
      AIRFLOW__CORE__EXECUTOR: LocalExecutor
      AIRFLOW__CORE__DAGS_ARE_PAUSED_AT_CREATION: "true"
      AIRFLOW__CORE__LOAD_EXAMPLES: "false"
      AIRFLOW__LOGGING__LOGGING_LEVEL: "INFO"

      # Настройки Execution API
      AIRFLOW__CORE__EXECUTION_API_SERVER_URL: "http://airflow-api-server:8080/execution/"
      AIRFLOW__WORKERS__EXECUTION_API_SERVER_URL: "http://airflow-api-server:8080/execution/"

      # >>> тот же JWT секрет
      AIRFLOW__API_AUTH__JWT_SECRET: "${AIRFLOW__API_AUTH__JWT_SECRET}"

    volumes:
      - ./dags:/opt/airflow/dags
      - ./logs:/opt/airflow/logs
      - ./plugins:/opt/airflow/plugins
    command: [ "bash", "-c", "sleep 5 && airflow dag-processor" ]

  # --- 4. scheduler (Использует LocalExecutor) ---
  airflow-scheduler:
    image: my-airflow:3.1.3
    depends_on:
      - postgres
      - airflow-init
      - airflow-api-server
      - airflow-dag-processor
    user: "${AIRFLOW_UID:-50000}:${AIRFLOW_GID:-0}"
    environment:
      # Настройки БД и FERNET_KEY
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://airflow:airflow@postgres/airflow
      AIRFLOW__CORE__FERNET_KEY: "${AIRFLOW__CORE__FERNET_KEY}"

      # Общие настройки
      AIRFLOW__CORE__EXECUTOR: LocalExecutor
      AIRFLOW__CORE__DAGS_ARE_PAUSED_AT_CREATION: "true"
      AIRFLOW__CORE__LOAD_EXAMPLES: "false"
      AIRFLOW__LOGGING__LOGGING_LEVEL: "INFO"

      # Настройки Execution API
      AIRFLOW__CORE__EXECUTION_API_SERVER_URL: "http://airflow-api-server:8080/execution/"
      AIRFLOW__WORKERS__EXECUTION_API_SERVER_URL: "http://airflow-api-server:8080/execution/"

      # >>> тот же JWT секрет
      AIRFLOW__API_AUTH__JWT_SECRET: "${AIRFLOW__API_AUTH__JWT_SECRET}"

    volumes:
      - ./dags:/opt/airflow/dags
      - ./logs:/opt/airflow/logs
      - ./plugins:/opt/airflow/plugins
    command: [ "airflow", "scheduler" ]

volumes:
  postgres-data:
